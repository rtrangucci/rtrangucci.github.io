<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Missing data lecture 1</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-fd68462179fdb1eb8400a3e2e38edf1e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script>
window.MathJax = {
  startup: {
    ready() {
      MathJax.startup.defaultReady();
      const {STATE} = MathJax._.core.MathItem;
      MathJax.tex2mml(String.raw`
        \newcommand{\lp}{\left(}
        \newcommand{\rp}{\right)}
        \newcommand{\lb}{\left[}
        \newcommand{\rb}{\right]}
        \newcommand{\ind}[1]{\mathbbm{1}\lp#1\rp}
        \newcommand{\Exp}[1]{\mathbb{E} \lb #1 \rb}
        \newcommand{\ExpA}[2]{\mathbb{E}_{#2} \lb #1 \rb}
        \newcommand{\indy}{\mathrel{\unicode{x2AEB}}}
        \newcommand{\Prob}[2]{\mathbb{P}_{#2} \lp #1 \rp}
        \newcommand{\abs}[1]{\left| #1 \right|}
      `);
    }
  },
  loader: {load: ['[tex]/bbm']},
  tex: {packages: {'[+]': ['bbm']}}
};
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@4.1/tex-mml-chtml.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../papers.html"> 
<span class="menu-text">My papers</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Random thoughts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../courses.html"> 
<span class="menu-text">Courses</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#does-missingness-matter" id="toc-does-missingness-matter" class="nav-link" data-scroll-target="#does-missingness-matter">Does missingness matter?</a></li>
  </ul></li>
  <li><a href="#patterns-and-mechanisms" id="toc-patterns-and-mechanisms" class="nav-link" data-scroll-target="#patterns-and-mechanisms">Patterns and mechanisms</a>
  <ul class="collapse">
  <li><a href="#missingness-patterns" id="toc-missingness-patterns" class="nav-link" data-scroll-target="#missingness-patterns">Missingness patterns</a></li>
  <li><a href="#missingness-mechanisms" id="toc-missingness-mechanisms" class="nav-link" data-scroll-target="#missingness-mechanisms">Missingness mechanisms</a>
  <ul class="collapse">
  <li><a href="#missing-completely-at-random-mcar" id="toc-missing-completely-at-random-mcar" class="nav-link" data-scroll-target="#missing-completely-at-random-mcar">Missing completely at random (MCAR)</a></li>
  <li><a href="#missing-at-random-mar" id="toc-missing-at-random-mar" class="nav-link" data-scroll-target="#missing-at-random-mar">Missing at random (MAR)</a></li>
  <li><a href="#missing-not-at-random-mnar" id="toc-missing-not-at-random-mnar" class="nav-link" data-scroll-target="#missing-not-at-random-mnar">Missing-not-at-random (MNAR)</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Missing data lecture 1</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>At first glance the title of our textbook, Statistical Analysis with Missing Data, seems redundant. What is statistics but the study of drawing conclusions from limited data? One of the most basic applications of statistics is about how to make inferences about a population quantity from a simple random sample of that population. The measurements from those who were not sampled are, by definition, missing. Because we have a simple random sample from our population, however, we can be sure that the sample mean of the measurements from the sampled units will be an unbiased estimator of the population-level mean. What if some of the sampled units refuse to participate in the survey? Suppose the survey asks about income, and some respondents refuse to report income?</p>
<p>Our definition of missing data for this course will condition on the sample drawn; in other words, we will focus on values that haven’t been recorded for the sample of data we observe. Suppose we have a sample of <span class="math inline">\(n\)</span> units, on which we have <span class="math inline">\(K\)</span> measurements, collected into a <span class="math inline">\(n \times K\)</span> matrix <span class="math inline">\(Y\)</span> with elements <span class="math inline">\(y_{ij}\)</span>.</p>
<p>Paired with this matrix of measurements is another <span class="math inline">\(n \times K\)</span> matrix <span class="math inline">\(M\)</span> with elements <span class="math inline">\(m_{ij}\)</span>, called the missingness indicator matrix. This matrix encodes the information about whether the <span class="math inline">\((i,j)^\mathrm{th}\)</span> element of <span class="math inline">\(Y\)</span> is missing or not. Let <span class="math inline">\(m_{ij} = 1\)</span> if <span class="math inline">\(y_{ij}\)</span> is missing, and <span class="math inline">\(0\)</span> if <span class="math inline">\(y_{ij}\)</span> is observed.</p>
<p>Throughout the course we’ll keep in mind that we’re never looking to explicitly fill in the missing values with a single ``best” value. Instead, we’re going to consider the distribution of possible values that could be filled in and look at how our estimates change for each filled-in dataset.</p>
<section id="does-missingness-matter" class="level2">
<h2 class="anchored" data-anchor-id="does-missingness-matter">Does missingness matter?</h2>
<p>The textbook defines missing data roughly as missing values that would be meaningful for your analysis if it had been observed <span class="citation" data-cites="little2019statistical">(<a href="#ref-little2019statistical" role="doc-biblioref">Roderick JA Little and Rubin 2019</a>)</span>. The word ``meaningful” is doing a lot of work here; we’ll need to define meaningful for ourselves. Conceptually, we need to define why data is missing in the first place. For example, let’s say we’re analyzing the results from a longitudinal trial comparing Infliximab for severe Crohn’s disease, which is an autoinflammatory disease and a category of inflammatory bowel disease (IBD) (note this is not IBS, or irritable bowel syndrome, which is fairly common), to a new treatment. The investigators are interested comparing Crohn’s Disease Activity Index (CDAI) between the two arms, which is a measure of the severity of symptoms in Crohn’s patients. Imagine two scenarios: one in which an enrolled patient subsequently drops out of the study after several infusions of the new treatment, and one in which an enrolled patient dies prior to the end of the study. In the first scenario, it makes sense to consider that patient’s measure of CDAI to be missing, whereas in the second scenario, it doesn’t make much sense to think about imputing a CDAI for someone who has died.</p>
<p>Let’s say we’re in the first scenario, and we’re confronted with some proportion of patients that have dropped out of the study. Dropout is common in longitudinal studies; in one dataset we’ll encounter later investigating the efficacy of a treatment for schizophrenia, about 37% of patients dropped out by the end of the study <span class="citation" data-cites="surrogate">(<a href="#ref-surrogate" role="doc-biblioref">Van Der Elst et al. 2024</a>)</span>. The default way to deal with missing data in R is to use <code>na.omit</code>. This is also known as <strong>complete case analysis</strong> (CC analysis). How much would just using the complete cases impact our inferences?</p>
<p>Being statisticians, we’ll focus on the bias and variance of our estimates. Let’s make things more concrete. Suppose in our Crohn’s trial the outcome <span class="math inline">\(Y_{i}\)</span> is the change from baseline CDAI to CDAI at the final visit. Assume that all participants have an initial CDAI, so <span class="math inline">\(M_i\)</span> is <span class="math inline">\(1\)</span> if the individual dropped out prior the final visit. As for bias, one can show (read: you’ll show on HW 1) that the following relationship holds: <span class="math display">\[
\Exp{Y \mid \ind{M = 0}} - \Exp{Y} = \frac{\text{Cov}(Y, \ind{M=0})}{\Exp{\ind{M=0}}}
\]</span> We can bound the magnitude of this expression by using Cauchy-Schwarz:</p>
<p><span class="math display">\[
\abs{\Exp{Y \mid \ind{M = 0}} - \Exp{Y}} \leq \frac{\text{SD}(Y) \text{SD}(\ind{M=0})}{\Exp{\ind{M=0}}}
\]</span> which simplifies to <span class="math display">\[
\abs{\Exp{Y \mid \ind{M = 0}} - \Exp{Y}} \leq \sqrt{\frac{\Exp{\ind{M=1}}}{\Exp{\ind{M=0}}}}\text{SD}(Y)
\]</span> This makes sense; for a given proportion of missing values, the larger the variance of <span class="math inline">\(Y\)</span> the larger the potential bias will be by excluding some of them.</p>
<p>This standard deviation is of course not estimable because we don’t have the missing values of <span class="math inline">\(Y\)</span>, but for variables with bounded support <span class="math inline">\(Y \in [a, b]\)</span>, we can get a further upper bound on the standard deviation using Popoviciu’s inequality: <span class="math display">\[
\text{Var}(Y) \leq \frac{(b - a)^2}{4}
\]</span> In the next code cell, I’ve written an expression for the upper bound of CDAI.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>upper_bound_CDAI <span class="ot">&lt;-</span> </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="dv">7</span> <span class="sc">*</span> <span class="dv">20</span> <span class="sc">*</span> <span class="dv">2</span> <span class="sc">+</span>  </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span> <span class="sc">*</span> <span class="dv">30</span> <span class="sc">+</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="dv">7</span> <span class="sc">*</span> <span class="dv">3</span> <span class="sc">*</span> <span class="dv">5</span> <span class="sc">+</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="dv">7</span> <span class="sc">*</span> <span class="dv">4</span> <span class="sc">*</span> <span class="dv">7</span> <span class="sc">+</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="dv">6</span> <span class="sc">*</span> <span class="dv">20</span> <span class="sc">+</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="dv">5</span> <span class="sc">*</span> <span class="dv">10</span> <span class="sc">+</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">42</span> <span class="sc">-</span> <span class="dv">3</span>) <span class="sc">*</span> <span class="dv">6</span> <span class="sc">+</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="dv">50</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The upper bound is approximately 1100 (see <span class="citation" data-cites="bestCrohns">(<a href="#ref-bestCrohns" role="doc-biblioref">Best 2006</a>)</span> for more details, the only value that may not have a hard upper bound is the number of stools per day, which I’ve set to <span class="math inline">\(20\)</span> above, but may be higher)</p>
<p>This is useful in our hypothetical example because the CDAI scale runs from <span class="math inline">\([0,1100]\)</span></p>
<p><span class="math display">\[
\abs{\Exp{Y \mid \ind{M = 0}} - \Exp{Y}} \leq \sqrt{\frac{\Exp{\ind{M=1}}}{\Exp{\ind{M=0}}}} \times 550
\]</span></p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lecture-1-notes_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>While these are worst-case bounds, this shows that even small proportions of missing values can impact inferences if the missingness is correlated with the outcome value.</p>
<p>There is also the variance to consider. Even if the covariance between the missing values is zero, we will lose efficiency by dropping observations that have missing values. In the case where our estimator is a sample mean, and there are <span class="math inline">\(n\)</span> units with <span class="math inline">\(m\)</span> missing values, the variance of the CC estimator will be larger by <span class="math inline">\(1 + \frac{m}{n - m}\)</span>.</p>
<p>Thus, in many cases, even if there are only small proportions of missing values, it can make sense to use partial information from incomplete cases to improve our estimators.</p>
</section>
</section>
<section id="patterns-and-mechanisms" class="level1">
<h1>Patterns and mechanisms</h1>
<p>Much of what we’ll study in our course relates to missingness patterns and missingness mechanisms. The former concerns the marginal distribution of <span class="math inline">\(M\)</span>, while the latter concerns the conditional distribution of <span class="math inline">\(M \mid Y\)</span>.</p>
<section id="missingness-patterns" class="level2">
<h2 class="anchored" data-anchor-id="missingness-patterns">Missingness patterns</h2>
<p>Consider three variables, <span class="math inline">\(Y_1, Y_2, Y_3\)</span> that we’ve measured on a sample of <span class="math inline">\(n\)</span> participants. Each variable has an associated binary vector: <span class="math inline">\(M_1, M_2, M_3\)</span>. <strong>Missingness patterns</strong> refer to the observed sample space for the vectors <span class="math inline">\([m_{i1}, m_{i2}, m_{i3}]\)</span>. The simplest missingness pattern is where only one of the variables is subject to missingness: <span class="math display">\[
[m_{i1}, m_{i2}, m_{i3}] \in \{[0,0,0], [0,0,1]\}.
\]</span> This is shown in <a href="#fig-uni" class="quarto-xref">Figure&nbsp;1</a>.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-uni" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-uni-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="lecture-1-notes_files/figure-html/fig-uni-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-uni-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Univariate missingness pattern (Credit goes in part to ChatGPT who wrote the initial version of this plot)
</figcaption>
</figure>
</div>
</div>
</div>
<p>We could also have multivariate missingness with only two missingness patterns <span class="math display">\[
[m_{i1}, m_{i2}, m_{i3}] \in \{[0,0,0], [0,1,1]\}
\]</span> which is shown in <a href="#fig-multi-uni" class="quarto-xref">Figure&nbsp;2</a>:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-multi-uni" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-multi-uni-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="lecture-1-notes_files/figure-html/fig-multi-uni-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-multi-uni-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Multivariate missingness pattern
</figcaption>
</figure>
</div>
</div>
</div>
<p>We could have something called monotone missingness, where we can order the missingness matrix such that if <span class="math inline">\(M_{i2} = 1\)</span> then so is <span class="math inline">\(M_{i3} = 1\)</span>: <span class="math display">\[
[m_{i1}, m_{i2}, m_{i3}] \in \{[0,0,0], [0,1,1], [0,0,1]\}
\]</span></p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-mono" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mono-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="lecture-1-notes_files/figure-html/fig-mono-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mono-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Monotone missingness pattern
</figcaption>
</figure>
</div>
</div>
</div>
<p>The least restricted missingness pattern is called a general pattern. This would be a case where there is no special structure. Of course, for <span class="math inline">\(p\)</span> variables each subject to missingness, the general missingness has a sample space of size <span class="math inline">\(2^p\)</span></p>
<p>If we consider that only <span class="math inline">\(Y_2, Y_3\)</span> are subject to missingness, then we have the following, depicted in :</p>
<p><span class="math display">\[
[m_{i1}, m_{i2}, m_{i3}] \in \{[0,0,0], [0,1,0], [0,0,1], [0,1,1]\}
\]</span></p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-general" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-general-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="lecture-1-notes_files/figure-html/fig-general-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-general-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: General missingness pattern for two variables
</figcaption>
</figure>
</div>
</div>
</div>
<p>Not surprisingly, the general missingness pattern is the most realistic. You might imagine these patterns occurring during a survey. The pattern <span class="math inline">\([0,1,1]\)</span> represents unit nonresponse (where a person who is contacted declines to participate in the survey), while <span class="math inline">\([0,1,0], [0,0,1]\)</span> would be item nonresponse.</p>
<p>The reason that categorizing patterns of missingness is useful is because it can suggest different methods for dealing with missing data. It’s also something that is observable; missing values are not observable, but the patterns are. Thus, in the survey unit and item nonresponse, we might consider different strategies for dealing with unit nonresponse and item nonresponse.</p>
</section>
<section id="missingness-mechanisms" class="level2">
<h2 class="anchored" data-anchor-id="missingness-mechanisms">Missingness mechanisms</h2>
<p>The most important paper in missing data was published by Don Rubin in 1976 <span class="citation" data-cites="rubinInferenceMissingData1976">Donald B. Rubin (<a href="#ref-rubinInferenceMissingData1976" role="doc-biblioref">1976</a>)</span>. Somewhat surprisingly to me, this paper was rejected by many stats journals. Rod Little says that he was assigned to review the paper as a graduate student when it was submitted to Biometrika, and he was convinced the paper was wrong after writing a long review. Luckily Little was overridden by his advisor, David Cox, who thought the paper was right, and decided to accept the paper.</p>
<p>The paper was important because it formalized methods of modeling missingness indicators, or the <span class="math inline">\(M\)</span> matrix from above. Prior to this paper, the <span class="math inline">\(M\)</span> matrix was not considered an outcome that could be modeled. Rubin’s paper instead categorized <span class="math inline">\(M\)</span> as a random variable, and determined how the conditional distribution <span class="math inline">\(M \mid Y\)</span> impacted inferences using only the observed values of <span class="math inline">\(Y\)</span>.</p>
<p>The various ways in which <span class="math inline">\(M\)</span> can depend on <span class="math inline">\(Y\)</span> is really an investigation of <em>why</em> a value is missing. Is a survey respondent unwilling to report their income because is high? Did the patient drop out of the study because of side-effects of a drug, or because the drug exacerbated their condition? Did a database error lead to the random dropping of records?</p>
<p>The crux of missing data analysis hinges in what we’re willing to believe about why data are missing. These beliefs aren’t typically testable, unless we have designed our study to have missingness<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<p>Again, let <span class="math inline">\(M\)</span> be the matrix with <span class="math inline">\((i,j)^\text{th}\)</span> entry <span class="math inline">\(m_{ij}\)</span>. Further, let <span class="math inline">\(m_i\)</span> be the <span class="math inline">\(i^\text{th}\)</span> row of <span class="math inline">\(M\)</span>. Let <span class="math inline">\(Y\)</span>, <span class="math inline">\(y_{ij}\)</span> and <span class="math inline">\(y_i\)</span> be similarly defined. We assume for simplicity (and for much of the book) that <span class="math inline">\((m_i, y_i)\)</span> are independent between rows.</p>
<p>To put a finer point on it, there are generally three categories of missingness mechanisms. They each relate to the distribution: <span class="math display">\[
f_{M \mid Y}(m_i \mid y_i, \phi),
\]</span> where <span class="math inline">\(\phi\)</span> are the parameters that govern the missingness mechanism.</p>
<p>It will be useful in the next subsections to define the following partitions of <span class="math inline">\(y_i\)</span>: Let <span class="math display">\[y_{(0)i} = (y_{ij} : m_{ij} = 0)\]</span> be the vector of components of <span class="math inline">\(y_i\)</span> that are observed for unit <span class="math inline">\(i\)</span> and let <span class="math display">\[y_{(1)i} = (y_{ij} : m_{ij} = 1)\]</span> denote the vector of <span class="math inline">\(y_i\)</span> components that are missing for <span class="math inline">\(y_i\)</span>.</p>
<p>We can see that <span class="math inline">\(y_{(0)i}, y_{(1)i}\)</span> depend on <span class="math inline">\(m_i\)</span>.</p>
<section id="missing-completely-at-random-mcar" class="level3">
<h3 class="anchored" data-anchor-id="missing-completely-at-random-mcar">Missing completely at random (MCAR)</h3>
<p>The simplest mechanism is called missing-completely-at-random (MCAR). This is where the missingness is unrelated to the outcome. Data are said to MCAR if the following holds for all <span class="math inline">\(i\)</span>, <span class="math inline">\(y_i\)</span>, <span class="math inline">\(y^\star_i\)</span>, and <span class="math inline">\(\phi\)</span>: <span class="math display">\[
f_{M\mid Y}(m_i \mid y_i, \phi) = f_{M\mid Y}(m_i \mid y^*_i, \phi).
\]</span> An imporant clarification is that this <strong>NOT</strong> a conditional independence assumption. It is an assumption about the evaluation of the conditional mass function <span class="math inline">\(f_{M \mid Y}(m_i \mid y_i, \phi)\)</span> at a <em>specific</em> <span class="math inline">\(m_i\)</span> <span class="citation" data-cites="mealliClarifyingMissingRandom2015">(<a href="#ref-mealliClarifyingMissingRandom2015" role="doc-biblioref">Mealli and Rubin 2015</a>)</span>. This point is often misunderstood (including by me).</p>
<p>Conditional independence, <span class="math inline">\(M \indy Y\)</span> would be characterized as missing-always-completely-at-random (MACAR): Data are said to MACAR if the following holds for all <span class="math inline">\(i\)</span>, <span class="math inline">\(m_i\)</span>, <span class="math inline">\(y_i\)</span>, <span class="math inline">\(y^\star_i\)</span>, and <span class="math inline">\(\phi\)</span>: <span class="math display">\[
f_{M\mid Y}(m_i \mid y_i, \phi) = f_{M\mid Y}(m_i \mid y^*_i, \phi).
\]</span> The next mechanism is less restrictive than MCAR.</p>
</section>
<section id="missing-at-random-mar" class="level3">
<h3 class="anchored" data-anchor-id="missing-at-random-mar">Missing at random (MAR)</h3>
<p>Missing at random data are characterized by the following equality for all <span class="math inline">\(i\)</span>, <span class="math inline">\(y_{(1)i}\)</span>, <span class="math inline">\(y^*_{(1)i}\)</span>, and <span class="math inline">\(\phi\)</span>: <span class="math display">\[
f_{M\mid Y}(m_i \mid y_{(0)i}, y_{(1)i} \phi) = f_{M\mid Y}(m_i \mid y_{(0)i}, y^*_{(1)i} \phi)
\]</span> Again, as with MCAR, this is a statement about the evaluation of the function <span class="math inline">\(f_{M\mid Y}(m_i \mid y_i, \phi)\)</span>. We can define a missing-at-random variant, missing-always-at-random (MAAR) that is equivalent to <span class="math inline">\(M \indy Y_{(1)i} \mid Y_{(0)i}\)</span><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p>
<p>The following example is adapted from <span class="citation" data-cites="mealliClarifyingMissingRandom2015">Mealli and Rubin (<a href="#ref-mealliClarifyingMissingRandom2015" role="doc-biblioref">2015</a>)</span>: Suppose we’re analyzing data from that Crohn’s disease trial and <span class="math inline">\(y_i\)</span> has two components: <span class="math inline">\(y_{i1}\)</span> is CDAI at visit 1 and <span class="math inline">\(y_{i2}\)</span> is CDAI at visit 2. For patient <span class="math inline">\(i\)</span> suppose that <span class="math inline">\(m_i = (1, 0)\)</span>. Consider two scenarios:</p>
<ol type="1">
<li><p><span class="math inline">\(y_{i2}\)</span> is missing because <span class="math inline">\(y_{i1} &gt; \phi\)</span></p></li>
<li><p><span class="math inline">\(y_{i2}\)</span> is missing because <span class="math inline">\(y_{i2} &gt; \phi\)</span></p></li>
</ol>
<p>In scenario 1 the data are MAR because the mass function is a function of <span class="math inline">\(y_{i1}\)</span> only, while in scenario 2 the data do not satisfy the definition of MAR.</p>
<p>Let’s make this example more general. The following is from <span class="citation" data-cites="little2019statistical">Roderick JA Little and Rubin (<a href="#ref-little2019statistical" role="doc-biblioref">2019, 23</a>)</span>. Again consider the bivariate case with <span class="math inline">\(y_{i1}, y_{i2}\)</span>. There are 4 possible missing data patterns: <span class="math display">\[
(m_{i1}, m_{i2}) \in \{(0,0), (0,1), (1,0), (1,1)\}
\]</span> We’ll need to define <span class="math inline">\(f_{M \mid Y}(m_{i1} = r, m_{i2} = s \mid y_{i1}, y_{i2}, \phi)\)</span>. To simplify the notation, let <span class="math display">\[
g_{rs}(y_{i1}, y_{i2}, \phi) = f_{M \mid Y}(m_{i1} = r, m_{i2} = s \mid y_{i1}, y_{i2}, \phi)
\]</span> The MAR assumption implies the following: <span class="math display">\[
\begin{aligned}
g_{11}(y_{i1}, y_{i2}, \phi) &amp; = g_{11}(\phi) \\
g_{01}(y_{i1}, y_{i2}, \phi) &amp; = g_{01}(y_{i1}, \phi) \\
g_{10}(y_{i1}, y_{i2}, \phi) &amp; = g_{10}(y_{i2}, \phi) \\
g_{00}(y_{i1}, y_{i2}, \phi) &amp; = 1 - g_{10}(y_{i2}, \phi)  - g_{01}(y_{i1}, \phi) -  g_{11}(\phi)
\end{aligned}
\]</span> Thus the probability that <span class="math inline">\(y_{ij}\)</span> is missing can depend only on <span class="math inline">\(y_{i(-j)}\)</span>, which is a bit odd.</p>
<p><span class="citation" data-cites="little2019statistical">Roderick JA Little and Rubin (<a href="#ref-little2019statistical" role="doc-biblioref">2019</a>)</span> proposes the following modification:</p>
<p><span class="math display">\[
\begin{aligned}
g_{11}(y_{i1}, y_{i2}, \phi) &amp; = g_{1+}(y_{i1}, \phi)g_{+1}(y_{i2}, \phi) \\
g_{01}(y_{i1}, y_{i2}, \phi) &amp; = (1 - g_{1+}(y_{i1}, \phi))g_{+1}(y_{i2}, \phi) \\
g_{10}(y_{i1}, y_{i2}, \phi) &amp; = g_{1+}(y_{i1}, \phi)(1 - g_{+1}(y_{i2}, \phi)) \\
g_{00}(y_{i1}, y_{i2}, \phi) &amp; = (1 - g_{1+}(y_{i1}, \phi))(1 - g_{+1}(y_{i2}, \phi))
\end{aligned}
\]</span> While this is maybe more realistic, though it does make an assumption that <span class="math inline">\(m_{i1}\)</span> and <span class="math inline">\(m_{i2}\)</span> are conditionally independent given <span class="math inline">\(y_{i1}, y_{i2}\)</span>, it is also hard to estimate, because we won’t observe missing values of <span class="math inline">\(y_{i1}\)</span> and <span class="math inline">\(y_{i2}\)</span>.</p>
<p>This is a scenario called missing-not-at-random, or MNAR. This is defined in the next subsection.</p>
</section>
<section id="missing-not-at-random-mnar" class="level3">
<h3 class="anchored" data-anchor-id="missing-not-at-random-mnar">Missing-not-at-random (MNAR)</h3>
<p>MNAR data is characterized by the following relationship:</p>
<p><span class="math display">\[
f_{M\mid Y}(m_i \mid y_{(0)i}, y_{(1)i} \phi) \neq f_{M\mid Y}(m_i \mid y_{(0)i}, y^*_{(1)i} \phi)
\]</span> for some <span class="math inline">\(\phi\)</span> and <span class="math inline">\(y_{(0)i} \neq y^*_{(0)i}\)</span> <span class="citation" data-cites="mealliClarifyingMissingRandom2015">(<a href="#ref-mealliClarifyingMissingRandom2015" role="doc-biblioref">Mealli and Rubin 2015</a>)</span>.</p>
<p>The version using conditional dependence is called missing not always at random, or MNAAR, which is</p>
<p><span class="math display">\[
f_{M\mid Y}(m_i \mid y_{(0)i}, y_{(1)i} \phi) \neq f_{M\mid Y}(m_i \mid y_{(0)i}, y^*_{(1)i} \phi)
\]</span></p>
<p>for some <span class="math inline">\(\phi, m_i, y_{(1)i}\)</span> and <span class="math inline">\(y_{(0)i} \neq y^*_{(0)i}\)</span></p>
<p>Our textbook mentions that sometimes MAR can yield better results than MNAR, citing <span class="citation" data-cites="rubin1995handling">Donald B. Rubin, Stern, and Vehovar (<a href="#ref-rubin1995handling" role="doc-biblioref">1995</a>)</span>. This is something we’ll explore later on in the course, namely how we would determine whether it was worth it to fit an MNAR model vs.&nbsp;a MAR model. Not surpisingly, like most things in statistics, the answer is ``It depends.”</p>
<div style="page-break-after: always;"></div>



</section>
</section>
</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-bestCrohns" class="csl-entry" role="listitem">
Best, William R. 2006. <span>“Predicting the <span>Crohnʼs</span> Disease Activity Index from the Harvey-Bradshaw Index:”</span> <em>Inflammatory Bowel Diseases</em> 12 (4): 304–10.
</div>
<div id="ref-littleMissingDataAssumptions2021" class="csl-entry" role="listitem">
Little, Roderick J. 2021. <span>“Missing <span>Data</span> <span>Assumptions</span>.”</span> <em>Annual Review of Statistics and Its Application</em> 8 (1): 89–107. <a href="https://doi.org/10.1146/annurev-statistics-040720-031104">https://doi.org/10.1146/annurev-statistics-040720-031104</a>.
</div>
<div id="ref-little2019statistical" class="csl-entry" role="listitem">
Little, Roderick JA, and Donald B Rubin. 2019. <em>Statistical Analysis with Missing Data</em>. John Wiley &amp; Sons.
</div>
<div id="ref-mealliClarifyingMissingRandom2015" class="csl-entry" role="listitem">
Mealli, Fabrizia, and Donald B. Rubin. 2015. <span>“Clarifying Missing at Random and Related Definitions, and Implications When Coupled with Exchangeability: <span>Table</span> 1.”</span> <em>Biometrika</em> 102 (4): 995–1000. <a href="https://doi.org/10.1093/biomet/asv035">https://doi.org/10.1093/biomet/asv035</a>.
</div>
<div id="ref-rubinInferenceMissingData1976" class="csl-entry" role="listitem">
Rubin, Donald B. 1976. <span>“Inference and <span>Missing</span> <span>Data</span>.”</span> <em>Biometrika</em> 63 (3): 581–92. <a href="https://doi.org/10.2307/2335739">https://doi.org/10.2307/2335739</a>.
</div>
<div id="ref-rubin1995handling" class="csl-entry" role="listitem">
Rubin, Donald B, Hal S Stern, and Vasja Vehovar. 1995. <span>“Handling <span>‘Don’t Know’</span> Survey Responses: The Case of the Slovenian Plebiscite.”</span> <em>Journal of the American Statistical Association</em> 90 (431): 822–28.
</div>
<div id="ref-surrogate" class="csl-entry" role="listitem">
Van Der Elst, Wim, Florian Stijven, Fenny Ong, Dries De Witte, Paul Meyvisch, Alvaro Poveda, Ariel Alonso, Hannah Ensor, Christoper Weir, and Geert Molenberghs. 2024. <em>Surrogate: Evaluation of Surrogate Endpoints in Clinical Trials</em>. <a href="https://CRAN.R-project.org/package=Surrogate">https://CRAN.R-project.org/package=Surrogate</a>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>One way that can happen is in a univariate missingness setting where <span class="math inline">\(Y_3\)</span> respresents a hard-to-measure quantity (say number of REM cycles per night) and <span class="math inline">\(Y_1, Y_2\)</span> are proxies for this quantity. If we randomly select a subset of our participants in which to measure <span class="math inline">\(Y_3\)</span> then we know that missingness <span class="math inline">\(M\)</span> is not related to <span class="math inline">\(Y\)</span> (assuming that none of our selected participants refuse to participate!).<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Missing always at random (MAAR)</p>
<p>Missing always at random data are characterized by the following equality for all <span class="math inline">\(i\)</span>, <span class="math inline">\(m_i\)</span> <span class="math inline">\(y_{(1)i}\)</span>, <span class="math inline">\(y^*_{(1)i}\)</span>:</p>
<p><span class="math display">\[
f_{M\mid Y}(m_i \mid y_{(0)i}, y_{(1)i} \phi) = f_{M\mid Y}(m_i \mid y_{(0)i}, y^*_{(1)i} \phi)
\]</span> This is a more restrictive assumption than MAR alone, though one could see why MAAR might be invoked for asymptotic arguments <span class="citation" data-cites="littleMissingDataAssumptions2021">(<a href="#ref-littleMissingDataAssumptions2021" role="doc-biblioref">Roderick J. Little 2021</a>)</span>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>