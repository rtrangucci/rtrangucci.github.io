<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Heckman models in Stan</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../papers.html">
 <span class="menu-text">My papers</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../blog.html">
 <span class="menu-text">Random thoughts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../courses.html">
 <span class="menu-text">Courses</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Heckman models in Stan</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>This is cmdstanr version 0.8.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStanR documentation and vignettes: mc-stan.org/cmdstanr</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStan path: /Users/robertntrangucci/.cmdstan/cmdstan-2.36.0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStan version: 2.36.0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: stats4</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: splines</code></pre>
</div>
</div>
<p>I took a class in the first year of my Master’s program about missing data from Ben Goodrich. The class was all about what to do when you encountered some sort of missing observations when analyzing a dataset. Missingness can arise for many reasons when analyzing data: it can arise from people declining to participate in a survey, survey respondents refusing to answer a question, from patients who drop out of a randomized study, or from the fact that an outcome of interest is only observable for a subset of patients who experience (or don’t experience) an intermediate event.</p>
<p>When dealing with missing data, it is crucial that we understand why an observation, be it an outcome, a covariate, or a unit, is missing. If the</p>
<p>The Heckman selection model was one of the first examples we were shown in class of a missing data problem where the probability that an individual had a missing observation depended on the value of the missing observation <span class="citation" data-cites="heckman1979">(<a href="#ref-heckman1979" role="doc-biblioref">Heckman 1979</a>)</span>. These are the hardest problems to address in missing data because</p>
<p>A standard survey example would be that people with very high and those with very low incomes may decline to report income on a survey more than those with moderate incomes. In the vaccine example, the selection effect we are concerned with is that people with weaker immune systems may become infected even with a vaccine and thus have higher viral loads. A naive comparison of viral loads between vaccinated and unvaccinated people might show that the vaccine increases viral loads in those who are vaccinated <span class="citation" data-cites="hudgens2003">(<a href="#ref-hudgens2003" role="doc-biblioref">Hudgens, Hoering, and Self 2003</a>)</span>.</p>
<p>To make things a little more concrete, suppose we’re interested in learning about the how vaccines moderate post-infection viral loads. The precise quantity we’re interested in is the change in post-infection viral load for people who would be infected with the pathogen no matter their vaccination status. These unlucky people are referred to as the ``Always-Infected’’ group. We might be tempted to get a rough estimate of this quantity by comparing viral loads in infected people in the vaccinated group vs.&nbsp;those in the unvaccinated group. The problem with this analysis is that if the vaccine has any causal effect on infection the individual characteristics of the two groups, infected-vaccinated people and infected-unvaccinated people, may differ. In this problem missingness arises in two forms. The first is that we observe only one outcome for each participant in our trial: the outcome corresponding to the treatment arm assignment. This is what Holland called the fundamental problem of causal inference. The second is more unique to this setting: we observe viral loads only in those who are infected.</p>
<p>Let <span class="math inline">\(Z_i\)</span> be the vaccine treatment, with <span class="math inline">\(Z_i = 1\)</span> indicating treatment and <span class="math inline">\(Z_i = 0\)</span> indicating placebo. For the ease of exposition, let’s suppose that treatment is randomized. We don’t need more selection bias (though selection into treatment could very well be a source of additional selection bias). Let <span class="math inline">\(S_i(z)\)</span> be the infection status of individual <span class="math inline">\(i\)</span> with vaccination status <span class="math inline">\(z\)</span>, and let <span class="math inline">\(Y_i(z)\)</span> be the viral load of individual <span class="math inline">\(i\)</span>. If <span class="math inline">\(S_i(z) = 0\)</span>, we set <span class="math inline">\(Y_i(z) = *\)</span>.</p>
<p>Suppose we also observe the study site, denoted as <span class="math inline">\(R_i\)</span>. This is the hospital or health clinic that enrolled patient <span class="math inline">\(i\)</span> into the study. This study site is assumed to impact that probability of infection, but it is assumed to be independent of post-infection viral load. The standard term for a variable like <span class="math inline">\(R_i\)</span> is an instrumental variable.</p>
<p>The model we’ll simulate data from is the following: <span class="math display">\[
\begin{aligned}
\log Y_i(z) &amp; = \mu_Y(z) + \sigma_z\, U_i(z) \\
\tilde{S}_i(z) \mid R_i &amp; = \mu_S(R_i) + z \,\gamma_S + W_i \\
S_i(z) &amp; = 1(\tilde{S}_i(z) &gt; 0) \\
(U_i(0),U_i(1),W_i) &amp; \sim \text{Normal}(\mathbf{0}, \boldsymbol{\Omega})
\end{aligned}
\]</span> The individuals who are always infected are identified as those with <span class="math inline">\(\{S_i(1) = 1,S_i(0) = 1\}\)</span>. One key assumption of this model is that these individuals can be identified with certainty. This is also known as a assumption. To see why, let’s see what our model implies about the always-infected event: <span class="math display">\[
\begin{aligned}
\{S_i(1) = 1, S_i(0) = 1\} &amp; = \{\tilde{S}_i(1) &gt; 0, \tilde{S}_i(0) &gt; 0\} \\
&amp; = \{\mu_S(R_i) + \gamma_S &gt; -W_i, \mu_S(R_i) &gt; -W_i\} \\
&amp; = \{\min(\mu_S(R_i) + \gamma_S,\mu_S(R_i))  &gt; -W_i\}
\end{aligned}
\]</span> The event that <span class="math inline">\(S_i(z) = 1\)</span> is equivalent to <span class="math display">\[
\{\mu_S(R_i) + \gamma_S &gt; -W_i\}
\]</span> Thus, if <span class="math inline">\(\gamma_S\)</span> is less than zero, as we would hope in a vaccine efficacy trial, then those who are infected in the vaccine arm are also those who would be infected in the placebo arm. The monotonicity assumption is a consequence of two assumptions of the model: - there is one error term for the probit regression - there is no individual heterogeneity in the coefficient <span class="math inline">\(\gamma_S\)</span>.</p>
<p>The likelihood for the model is fairly straightforward: For individuals who remain uninfected, the likelihood term corresponds to <span class="math inline">\(P(\tilde{S}_i(z) \leq 0)\)</span>, which corresponds to the univariate standard normal CDF evaluated at <span class="math inline">\(-\mu_S(z,r)\)</span>, or: <span class="math display">\[
P(\mu_S(z,r) + W_i \leq 0) = \Phi(-\mu_S(z,r))
\]</span></p>
<p>The likelihood for an individual <span class="math inline">\(i\)</span> who is infected corresponds to observing <span class="math inline">\(\log Y_i(z) = y_i\)</span> and <span class="math inline">\(\tilde{S}_i(z) &gt; 0 \mid \log Y_i(z) = y_i, R_i = r_i\)</span>: <span id="eq-pos-idx"><span class="math display">\[
\begin{aligned}
L_i(\theta) &amp; = \frac{1}{\sqrt{2\pi} \sigma_z}\exp\left(-\frac{1}{2\sigma_z^2}(y_i - \mu_Y(z_i))^2\right) \\
&amp; \Phi\left(\frac{\mu_S(z_i) + \frac{\rho_{z_i}}{\sigma_z}(y_i - \mu_Y(z_i))}{\sqrt{1 - \rho_{z_i}^2}}\right)
\end{aligned}
\tag{1}\]</span></span></p>
<p>where <span class="math inline">\(\rho_z = \text{Cor}(W_i,U_i(z))\)</span>.</p>
<p>To get a sense for what this model implies about the treatment effect, let’s examine the conditional expectation of <span class="math inline">\(Y_i(z)\)</span> given <span class="math inline">\(\tilde{S}_i(z) &gt; 0\)</span> when a patient is vaccinated vs.&nbsp;when the patient is unvaccinated:</p>
<p><span class="math display">\[
\tau^\text{naive} = \mathbb{E} \left[Y_i(1) \mid \tilde{S}_i(1) &gt; 0 \right] - \mathbb{E} \left[Y_i(0) \mid \tilde{S}_i(0) &gt; 0 \right]
\]</span> This is what we’ll call the naive estimand, because it conditions on a post-treatment outcome, namely infection, which can induce selection bias, as we’ll see.</p>
<p>The expectation <span class="math inline">\(\mathbb{E} \left[Y_i(z) \mid \tilde{S}_i(z) &gt; 0 \right]\)</span> is the following:</p>
<p><span class="math display">\[
\begin{aligned}
\frac{(2 \pi\sigma_z^2)^{-1/2}}{\Phi(\mu_S(z_i))}\int_{-\infty}^{\infty}  \exp\left(y-\frac{1}{2\sigma_z^2}(y - \mu_Y(z_i))^2\right)
\Phi\left(\frac{\mu_S(z_i) + \frac{\rho_{z_i}}{\sigma_z}(y - \mu_Y(z_i))}{\sqrt{1 - \rho_{z_i}^2}}\right) dy
\end{aligned}
\]</span> To my knowledge, this doesn’t have a closed form expression because of the exponentiation of <span class="math inline">\(y\)</span>, though there might be a clever way to evaluate this integral. We can, however, use R’s 1-d numerical integration routine to approximate this expectation.</p>
<p>The code below evaluates <span class="math inline">\(\tau^\text{naive}\)</span>, as well as</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>cond_exp <span class="ot">&lt;-</span> <span class="cf">function</span>(y, mu_y, mu_s, sd_y, rho) {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">exp</span>(y <span class="sc">+</span> <span class="fu">dnorm</span>(y, mu_y, sd_y, <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> <span class="fu">pnorm</span>((mu_s <span class="sc">+</span> rho <span class="sc">/</span> sd_y <span class="sc">*</span> (y <span class="sc">-</span> mu_y))<span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> rho<span class="sc">^</span><span class="dv">2</span>),<span class="at">log.p =</span> <span class="cn">TRUE</span>))</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>tau_naive <span class="ot">&lt;-</span> <span class="cf">function</span>(rho_0, rho_1, sd_y, mu_y, mu_s, s_eff, y_eff) {</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  I1 <span class="ot">&lt;-</span> <span class="fu">integrate</span>(cond_exp, <span class="sc">-</span><span class="cn">Inf</span>, <span class="cn">Inf</span>, </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mu_y =</span> mu_y <span class="sc">+</span> y_eff, </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mu_s =</span> mu_s <span class="sc">+</span> s_eff, </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd_y =</span> sd_y, </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">rho =</span> rho_1, </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">abs.tol =</span> 0L, </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">rel.tol =</span> .Machine<span class="sc">$</span>double.eps<span class="sc">^</span><span class="fl">0.85</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(I1<span class="sc">$</span>subdivisions <span class="sc">&gt;</span> <span class="dv">3</span>)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  D1 <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(mu_s <span class="sc">+</span> s_eff)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  I2 <span class="ot">&lt;-</span> <span class="fu">integrate</span>(cond_exp, <span class="sc">-</span><span class="cn">Inf</span>, <span class="cn">Inf</span>, </span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mu_y =</span> mu_y, </span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mu_s =</span> mu_s, </span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd_y =</span> sd_y, </span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>                  <span class="at">rho =</span> rho_0, </span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>                  <span class="at">abs.tol =</span> 0L, </span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>                  <span class="at">rel.tol =</span> .Machine<span class="sc">$</span>double.eps<span class="sc">^</span><span class="fl">0.85</span>)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(I2<span class="sc">$</span>subdivisions <span class="sc">&gt;</span> <span class="dv">3</span>)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  D2 <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(mu_s)</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(I1<span class="sc">$</span>value <span class="sc">/</span> D1 <span class="sc">-</span> I2<span class="sc">$</span>value <span class="sc">/</span> D2)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>true_eff <span class="ot">&lt;-</span> <span class="cf">function</span>(sd_y, mu_y, y_eff) {</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  mu_0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(mu_y <span class="sc">+</span> sd_y<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>  mu_1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(mu_y <span class="sc">+</span> y_eff <span class="sc">+</span> sd_y<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(mu_1 <span class="sc">-</span> mu_0)</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>delta_s <span class="ot">&lt;-</span> <span class="cf">function</span>(mu_z, s_eff) {</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>  p_0 <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(mu_z)</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>  p_1 <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(mu_z <span class="sc">+</span> s_eff)</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p_1 <span class="sc">-</span> p_0)</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First we’ll explore a scenario where there is high positive correlation between the errors in the viral load equation and the latent variable related to infection. We set <span class="math inline">\(\rho_1 = \rho_0 = 0.9\)</span>, <span class="math inline">\(\sigma_0 = \sigma_1 = 0.5\)</span>, <span class="math inline">\(\mu_Y(0) = 10\)</span> and <span class="math inline">\(\mu_S(0) = -1.5\)</span>. Let the true effect of the vaccine on mean log-viral load be <span class="math inline">\(\delta_y = -0.25\)</span>.</p>
<p>We will plot how the naive estimand of viral load effect changes with the change in infection probability.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>effs <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="at">by =</span> <span class="fl">0.01</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>p_s <span class="ot">&lt;-</span> <span class="fu">sapply</span>(effs, \(x) <span class="fu">delta_s</span>(<span class="sc">-</span><span class="fl">0.5</span>, x)) </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>estimand <span class="ot">&lt;-</span> <span class="fu">sapply</span>(effs, \(x) <span class="fu">f_naive_est</span>(<span class="at">rho =</span> <span class="fl">0.9</span>, <span class="at">sd_y =</span> <span class="fl">0.5</span>, <span class="at">mu_y =</span> <span class="dv">10</span>, <span class="at">mu_s =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">s_eff =</span> x, <span class="at">y_eff =</span> <span class="sc">-</span><span class="fl">0.25</span>))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>p_change_in_sign <span class="ot">&lt;-</span> p_s[<span class="fu">which.min</span>(<span class="fu">abs</span>(estimand))]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p_s, </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>     estimand,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Naive effect estimand vs. infection effect"</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="fu">bquote</span>(<span class="fu">E</span>(y <span class="sc">~</span> <span class="st">"|"</span> <span class="sc">~</span> S <span class="sc">==</span> <span class="dv">1</span>, Z <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">-</span> <span class="fu">E</span>(y <span class="sc">~</span> <span class="st">"|"</span> <span class="sc">~</span> S <span class="sc">==</span> <span class="dv">1</span>, Z <span class="sc">==</span> <span class="dv">0</span>)),</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="fu">bquote</span>(<span class="fu">P</span>(S <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"|"</span> <span class="sc">~</span> Z <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">-</span> <span class="fu">P</span>(S <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"|"</span> <span class="sc">~</span> Z <span class="sc">==</span> <span class="dv">0</span>)),</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">type=</span><span class="st">"l"</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> p_change_in_sign, <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="heckman-in-stan_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This graph shows that as the vaccine becomes more effective at preventing infection, the apparent benefit of the vaccine on viral load decreases. In fact, at around a -0.18 decrease in the probability of infection, the naive estimand shows that the vaccine increases viral load, which is not the case.</p>
<p>If we fix a scenario and</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>effs <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="at">by =</span> <span class="fl">0.01</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>p_s <span class="ot">&lt;-</span> <span class="fu">sapply</span>(effs, \(x) <span class="fu">delta_s</span>(<span class="sc">-</span><span class="fl">0.5</span>, x)) </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>estimand <span class="ot">&lt;-</span> <span class="fu">sapply</span>(effs, \(x) <span class="fu">f_naive_est</span>(<span class="at">rho =</span> <span class="fl">0.9</span>, <span class="at">sd_y =</span> <span class="fl">0.5</span>, <span class="at">mu_y =</span> <span class="dv">10</span>, <span class="at">mu_s =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">s_eff =</span> x, <span class="at">y_eff =</span> <span class="sc">-</span><span class="fl">0.25</span>))</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>p_change_in_sign <span class="ot">&lt;-</span> p_s[<span class="fu">which.min</span>(<span class="fu">abs</span>(estimand))]</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p_s, </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>     estimand,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Naive effect estimand vs. infection effect"</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="fu">bquote</span>(<span class="fu">E</span>(y <span class="sc">~</span> <span class="st">"|"</span> <span class="sc">~</span> S <span class="sc">==</span> <span class="dv">1</span>, Z <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">-</span> <span class="fu">E</span>(y <span class="sc">~</span> <span class="st">"|"</span> <span class="sc">~</span> S <span class="sc">==</span> <span class="dv">1</span>, Z <span class="sc">==</span> <span class="dv">0</span>)),</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="fu">bquote</span>(<span class="fu">P</span>(S <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"|"</span> <span class="sc">~</span> Z <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">-</span> <span class="fu">P</span>(S <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"|"</span> <span class="sc">~</span> Z <span class="sc">==</span> <span class="dv">0</span>)),</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">type=</span><span class="st">"l"</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> p_change_in_sign, <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="heckman-in-stan_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Note that <span class="math inline">\(\rho_{01} = \text{Cor}(U_i(0),U_i(1))\)</span> does not enter into the likelihood, which makes sense because we’ll never observe both <span class="math inline">\(S_i(0)\)</span> and <span class="math inline">\(S_i(1)\)</span> for the same individual. This does <em>not</em> mean that we won’t have any information about <span class="math inline">\(\rho_{01}\)</span>; because <span class="math inline">\(\boldsymbol{\Omega}\)</span> must be positive definite, the <span class="math inline">\(\det \boldsymbol{\Omega} &gt; 0\)</span>. This means that what we do learn about <span class="math inline">\(\rho_0\)</span> and <span class="math inline">\(\rho_1\)</span> will constrain the domain of <span class="math inline">\(\rho_{01}\)</span> so that <span class="math inline">\(\det \boldsymbol{\Omega} &gt; 0\)</span>. This translates to the following bounds on <span class="math inline">\(\rho_{01}\)</span> <span class="math display">\[
\rho_{01} \in \left(\rho_0\rho_1 - \sqrt{1 - \rho_0^2 - \rho_1^2 + \rho_0^2\rho_1^2},\, \rho_0\rho_1 + \sqrt{1 - \rho_0^2 - \rho_1^2 + \rho_0^2\rho_1^2}\right)
\]</span> If we incorporate prior information, the asymptotic posterior for <span class="math inline">\(\rho_{01}\)</span> will take on the shape of the conditional prior for <span class="math inline">\(\rho_{01}\)</span> given the values for <span class="math inline">\(\rho_0\)</span> and <span class="math inline">\(\rho_1\)</span>.</p>
<p>Given our focus on comparing the impact of vaccination on viral load, the target causal estimand is a measure of the average decrease (hopefully) in viral load caused by vaccination in individuals who are always infected. Mathematically, this is: <span class="math display">\[\mathbb{E}[Y_i(1) - Y_i(0) \mid S_i(1) = S_i(0) = 1].\]</span> This estimand is somewhat odd in that we can never observe both infection outcomes, so we can never calculate this estimand exactly from observed data without extra assumptions. I explained above why we can’t equate this target estimand with the ``naive’’ version, the difference in viral load between vaccinated and unvaccinated people: <span class="math display">\[
\mathbb{E}[Y_i(1) \mid S_i(1) = 1] - \mathbb{E}[Y_i(0) \mid S_i(0) = 1].
\]</span> Logically, it makes sense, because the naive estimand is a mixture over several groups, instead of just the always-infected group, but we’ll simulate some data to get a better sense of how different the two estimands can be.</p>
<p>In our simulated example, we’ll suppose we have a randomized vaccine trial with 20,000 participants spread evenly across 10 study sites. We’ll set <span class="math inline">\(\rho_0\)</span> and <span class="math inline">\(\rho_1\)</span> to <span class="math inline">\(0.75\)</span>, which equates to strong residual correlation between infection risk and viral load; that might be reasonable if there is an unobserved factor impacting both infection and viral load. Maybe this is prior exposure to the virus plus genetic factors related to immune system health.</p>
<p>The covariates we’re including in the infection risk equation, <span class="math inline">\(\mu_S(z)\)</span> are age and study site, while the only covariates we’re including in the viral load model are categorical age predictors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12222</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">20000</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>sigma_0 <span class="ot">&lt;-</span> <span class="fl">0.7</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>sigma_1 <span class="ot">&lt;-</span> <span class="fl">0.7</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>sigma_W <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>rho_0 <span class="ot">&lt;-</span> <span class="fl">0.9</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>rho_1 <span class="ot">&lt;-</span> <span class="fl">0.9</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>lb <span class="ot">&lt;-</span> rho_0<span class="sc">*</span>rho_1 <span class="sc">-</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> rho_0<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> rho_1<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> rho_0<span class="sc">^</span><span class="dv">2</span><span class="sc">*</span>rho_1<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>ub <span class="ot">&lt;-</span> rho_0<span class="sc">*</span>rho_1 <span class="sc">+</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> rho_0<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> rho_1<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> rho_0<span class="sc">^</span><span class="dv">2</span><span class="sc">*</span>rho_1<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>rho_01 <span class="ot">&lt;-</span> <span class="fl">0.7</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>diag_sigs <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fu">c</span>(sigma_0,sigma_1,sigma_W))</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>Omega <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,rho_01,rho_0,rho_01,<span class="dv">1</span>,rho_1,rho_0,rho_1,<span class="dv">1</span>),<span class="dv">3</span>,<span class="dv">3</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>Sigma <span class="ot">&lt;-</span> diag_sigs <span class="sc">%*%</span> Omega  <span class="sc">%*%</span> diag_sigs</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>U0_U1_W <span class="ot">&lt;-</span> <span class="fu">mvrnorm</span>(<span class="at">n =</span> n, <span class="at">mu =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">Sigma =</span> Sigma)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The plot of <span class="math inline">\(U_0\)</span> vs.&nbsp;<span class="math inline">\(W\)</span> gives a sense of how related the two error terms are:</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="heckman-in-stan_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The covariates we will include in the model are age, which we treat as a categorical variable, the study site, which is also treated as a categorical variable, and the binary treatment variable, which is assumed to be balanced within study sites.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>N_age <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>N_sites <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>age_vec <span class="ot">&lt;-</span> <span class="fu">sample</span>(N_age, n, <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> <span class="fu">factor</span>()</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>site_vec <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>N_sites,<span class="at">each=</span>n <span class="sc">/</span> N_sites) <span class="sc">|&gt;</span> <span class="fu">factor</span>()</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>treat <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>,n<span class="sc">/</span><span class="dv">20</span>),<span class="fu">rep</span>(<span class="dv">1</span>,n<span class="sc">/</span><span class="dv">20</span>)),<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll create the model matrices from these variables, along with the coefficients for each model equation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>X_S <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> age_vec <span class="sc">+</span> site_vec)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>X_Y <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> age_vec)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>d_S <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X_S)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>d_Y <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X_Y)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>gamma_Y <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.25</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>gamma_S <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.85</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>beta_S <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.5</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fu">rnorm</span>(N_sites <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="fl">0.1</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>beta_Y <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">10.3</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>S_0  <span class="ot">&lt;-</span> (X_S <span class="sc">%*%</span> beta_S <span class="sc">+</span> U0_U1_W[,<span class="dv">3</span>]) <span class="sc">&gt;=</span> <span class="dv">0</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>S_1  <span class="ot">&lt;-</span> (X_S <span class="sc">%*%</span> beta_S <span class="sc">+</span> gamma_S <span class="sc">+</span> U0_U1_W[,<span class="dv">3</span>]) <span class="sc">&gt;=</span> <span class="dv">0</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>S <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">as.integer</span>(S_0), <span class="fu">as.integer</span>(S_1))</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>Y_0  <span class="ot">&lt;-</span> X_Y <span class="sc">%*%</span> beta_Y <span class="sc">+</span> U0_U1_W[,<span class="dv">1</span>]</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>Y_1  <span class="ot">&lt;-</span> X_Y <span class="sc">%*%</span> beta_Y <span class="sc">+</span> gamma_Y <span class="sc">+</span> U0_U1_W[,<span class="dv">2</span>]</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">ifelse</span>(S_0 <span class="sc">==</span> <span class="dv">1</span>, Y_0, <span class="cn">NA</span>),</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>           <span class="fu">ifelse</span>(S_1 <span class="sc">==</span> <span class="dv">1</span>, Y_1, <span class="cn">NA</span>))</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>sel <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">rbind</span>(<span class="dv">1</span><span class="sc">-</span>treat, treat))</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>S_o <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">t</span>(S))[sel <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>Y_o <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">t</span>(Y))[sel <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>idx_S_o <span class="ot">&lt;-</span> <span class="fu">which</span>(S_o <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>idx_AI <span class="ot">&lt;-</span> <span class="fu">which</span>(S_0 <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> S_1 <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>Y_o_sel <span class="ot">&lt;-</span> Y_o[idx_S_o]</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>X_Y_sel <span class="ot">&lt;-</span> X_Y[idx_S_o, ]</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>naive_estimand <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">exp</span>(Y_o_sel[treat[idx_S_o] <span class="sc">==</span> <span class="dv">1</span>])) <span class="sc">-</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mean</span>(<span class="fu">exp</span>(Y_o_sel[treat[idx_S_o] <span class="sc">==</span> <span class="dv">0</span>]))</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>Y_estimand <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">exp</span>(Y_1[idx_AI])) <span class="sc">-</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>               <span class="fu">mean</span>(<span class="fu">exp</span>(Y_0[idx_AI]))</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>n_s_0 <span class="ot">&lt;-</span> <span class="fu">sum</span>(treat[idx_S_o] <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>n_s_1 <span class="ot">&lt;-</span> <span class="fu">sum</span>(treat[idx_S_o] <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>n_AI <span class="ot">&lt;-</span> <span class="fu">length</span>(idx_AI)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After all is said and done, the finite-sample estimator for the population estimand is -63,883, with a standard error of 6888.1207534 while the naive estimator for the population estimand is 41,600 with a standard error of 8335.141496. Note that these standard errors are understated a bit because the selection indicators are treated as fixed. In reality, both the selection and the outcome are random, so a more complete standard error calculation would account for the randomness in both sets of outcomesboth sets of outcomes.</p>
<p>This means that the naive estimator understates the benefit of the vaccine for people who are always infected by about 165%.</p>
<p>The approximate standard error for the naive estimator is 6888.1207534, while the approximate standard error .</p>
<p>Let’s build the Stan model block by block. First, the <strong>data block</strong> needs to take in the sizes and types of all the matrices and vectors that we’ll need to fit the model.</p>
<ol type="1">
<li>Data block</li>
</ol>
<div class="cell" data-output.var="test">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; N;     </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; N_neg; </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; N_pos; </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; D_S;   </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; D_Y;   </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N_pos] Y;    </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=<span class="dv">1</span>&gt; S;  </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=<span class="dv">1</span>&gt; Z;  </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[N_pos,D_Y] X_Y; </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[N,D_S] X_S;  </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We need the number of observations, <code>N</code>, the number of negative and positive cases (<code>N_neg</code> and <code>N_pos</code>). We also need the dimensions of the predictors for the <span class="math inline">\(S\)</span> equation and the <span class="math inline">\(Y\)</span> equation, <code>D_S</code> and <code>D_Y</code>. The observed viral loads are collected into a length-<code>N_pos</code> vector <code>Y</code>, while the observed infection status and treatment assignment are collected into length-<code>N</code> binary integer arrays <code>S</code> and <code>Z</code>. Finally, we have the predictors for the <span class="math inline">\(Y\)</span> equation, <code>X_Y</code>, which is an <code>N_pos</code> by <code>D_Y</code> matrix, and the predictors for the <span class="math inline">\(S\)</span> equation, which is an <code>N</code> by <code>D_S</code> matrix.</p>
<ol start="2" type="1">
<li>Transformed data block</li>
</ol>
<p>The <strong>transformed data</strong> block is needed to collect the indices, measured from <span class="math inline">\(1,\dots,N\)</span>, of the negative cases (<span class="math inline">\(S_i = 0\)</span>) and positive cases (<span class="math inline">\(S_i = 1\)</span>). The reason we need this information is because the likelihood contribution to the infection status probit model, shown in <a href="#eq-pos-idx">Equation&nbsp;1</a>, requires the value of the log-viral load, so we’ll need to match the infection status outcomes to the viral load outcomes. We could do this matching in the R code outside the Stan model, but I prefer to do it within the Stan code so everything is in one place. We’ll collect the indices of the positive cases in <code>n_pos</code>, which is an array of length <code>N_pos</code> and holds integers between <code>1</code> and <code>N</code>, while negative case indices are collected in <code>n_neg</code>, defined similarly.</p>
<p>The other piece of information the infection status likelihood will need for positive cases is the value <span class="math inline">\(\rho_z\)</span>, which depends on the individual treatment assignment. This information is collected in the vector <code>Z_idx</code>.</p>
<div class="cell" data-output.var="test">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed data</span> {</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N_pos] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>,<span class="kw">upper</span>=N&gt; n_pos;</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N_neg] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=N&gt; n_neg;</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N] <span class="dt">int</span> Z_idx;</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i;</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> j;</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    i = <span class="dv">1</span>;</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    j = <span class="dv">1</span>;</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (S[n] == <span class="dv">1</span>) {</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        n_pos[i] = n;</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        i = i + <span class="dv">1</span>;</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        n_neg[j] = n;</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        j = j + <span class="dv">1</span>;</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>      Z_idx[n] = Z[n] + <span class="dv">1</span>;</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="3" type="1">
<li>Parameters block</li>
</ol>
<p>The <strong><em>parameter</em></strong> block is where we define which unknown parameters we need to estimate with our model. Our unknown parameters is the set: - <span class="math inline">\(\boldsymbol{\Omega}\)</span>: correlation matrix between the error terms for the regressions - <span class="math inline">\(\sigma_0\)</span>: error standard deviation for log-viral load regression in placebo group - <span class="math inline">\(\sigma_1\)</span>: error standard deviation for log-viral load regression in treatment group - <span class="math inline">\(\beta_y\)</span>: regression coefficients for the log-viral load regression - <span class="math inline">\(\beta_s\)</span> - <span class="math inline">\(\gamma_s\)</span> _y)$, the correlation matrix for the errors. In our case, we have a</p>
<div class="cell" data-output.var="test">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">cholesky_factor_corr</span>[<span class="dv">3</span>] L_Omega;</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt;[<span class="dv">2</span>] sd_Y;</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[D_Y] b_Y;</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[D_S] b_S;</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> gamma_S;</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> gamma_Y;</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The Stan model is written like so:</p>
<div class="cell" data-output.var="model">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; N;     </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; N_neg; </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; N_pos; </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; D_S;   </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; D_Y;   </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N_pos] Y;    </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=<span class="dv">1</span>&gt; S;  </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=<span class="dv">1</span>&gt; Z;  </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[N_pos,D_Y] X_Y; </span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[N,D_S] X_S;  </span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed data</span> {</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N_pos] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>,<span class="kw">upper</span>=N&gt; n_pos;</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N_neg] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=N&gt; n_neg;</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N] <span class="dt">int</span> Z_idx;</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i;</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> j;</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    i = <span class="dv">1</span>;</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    j = <span class="dv">1</span>;</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (S[n] == <span class="dv">1</span>) {</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>        n_pos[i] = n;</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>        i = i + <span class="dv">1</span>;</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>        n_neg[j] = n;</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>        j = j + <span class="dv">1</span>;</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>      Z_idx[n] = Z[n] + <span class="dv">1</span>;</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">cholesky_factor_corr</span>[<span class="dv">3</span>] L_Omega;</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt;[<span class="dv">2</span>] sd_Y;</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[D_Y] b_Y;</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[D_S] b_S;</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> gamma_S;</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> gamma_Y;</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[<span class="dv">3</span>,<span class="dv">3</span>] Omega = L_Omega * L_Omega';</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] mu_S = X_S * b_S + to_vector(Z) * gamma_S;</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N_pos] mu_Y = X_Y * b_Y + to_vector(Z[n_pos]) * gamma_Y;</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[<span class="dv">2</span>] <span class="dt">real</span> rho = {Omega[<span class="dv">1</span>,<span class="dv">3</span>], Omega[<span class="dv">2</span>,<span class="dv">3</span>]};</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>  b_Y ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>  b_S ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>  sd_Y ~ normal(<span class="dv">0</span>, <span class="dv">2</span>);</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>  gamma_S ~ normal(<span class="dv">0</span>, <span class="dv">5</span>);</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>  gamma_Y ~ normal(<span class="dv">0</span>, <span class="dv">5</span>);</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N_neg) {</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">target +=</span> log(Phi(-mu_S[n_neg[n]]));</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N_pos) {</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> treat_idx = Z_idx[n_pos[n]];</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">target +=</span> log(Phi(sqrt((<span class="dv">1</span> - rho[treat_idx]) * (<span class="dv">1</span> + rho[treat_idx]))^(-<span class="dv">1</span>)*(mu_S[n_pos[n]]</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>                               + rho[treat_idx] / sd_Y[treat_idx]</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>                               * (Y[n] - mu_Y[n]))));</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>    Y[n] ~ normal(mu_Y[n], sd_Y[treat_idx]);</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a><span class="kw">generated quantities</span> {</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[<span class="dv">2</span>] <span class="dt">real</span> rho = {Omega[<span class="dv">1</span>,<span class="dv">3</span>], Omega[<span class="dv">2</span>,<span class="dv">3</span>]};</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> Y_estimand = <span class="dv">0</span>;</span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vector</span>[N] mu_S = X_S * b_S;</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>    <span class="dt">matrix</span>[<span class="dv">3</span>,<span class="dv">3</span>] Sigma = quad_form_diag(Omega, append_row(sd_Y, [<span class="dv">1</span>]'));</span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> tot_11 = <span class="dv">0</span>;</span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>      <span class="dt">vector</span>[<span class="dv">3</span>] errors = multi_normal_rng(rep_vector(<span class="dv">0</span>,<span class="dv">3</span>), Sigma);</span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (errors[<span class="dv">3</span>] &gt; -mu_S[n] - gamma_S &amp;&amp; errors[<span class="dv">3</span>] &gt; -mu_S[n]) {</span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>        <span class="dt">real</span> mu_Y_cf = X_S[n,<span class="dv">1</span>:D_Y] * b_Y;</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>        <span class="dt">real</span> Y_0 = errors[<span class="dv">1</span>] + mu_Y_cf;</span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>        <span class="dt">real</span> Y_1 = errors[<span class="dv">2</span>] + mu_Y_cf + gamma_Y;</span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>        Y_estimand += Y_1 -  Y_0;</span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>        tot_11 += <span class="dv">1</span>;</span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>    Y_estimand /= tot_11;</span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-output.var="test">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed data</span> {</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N_pos] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>,<span class="kw">upper</span>=N&gt; n_pos;</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N_neg] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=N&gt; n_neg;</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N] <span class="dt">int</span> Z_idx;</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i;</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> j;</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    i = <span class="dv">1</span>;</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    j = <span class="dv">1</span>;</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (S[n] == <span class="dv">1</span>) {</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>        n_pos[i] = n;</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        i = i + <span class="dv">1</span>;</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        n_neg[j] = n;</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>        j = j + <span class="dv">1</span>;</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>      Z_idx[n] = Z[n] + <span class="dv">1</span>;</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Some comments on the Stan code are in order. The data block is pretty straightforward, though it’s worth keeping in mind that we’ll need to keep track of three dimensions: the total number of data points, the number of infected and uninfected patients. This is because we’ll only have access to viral loads in the infected patients.</p>
<p>Let’s generate some data to see how the errors change how the .</p>
<p>First, let’s see whether the</p>




<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-heckman1979" class="csl-entry" role="doc-biblioentry">
Heckman, James J. 1979. <span>“Sample Selection Bias as a Specification Error.”</span> <em>Econometrica</em> 47 (1): 153. <a href="https://doi.org/10.2307/1912352">https://doi.org/10.2307/1912352</a>.
</div>
<div id="ref-hudgens2003" class="csl-entry" role="doc-biblioentry">
Hudgens, Michael G., Antje Hoering, and Steven G. Self. 2003. <span>“On the Analysis of Viral Load Endpoints in HIV Vaccine Trials.”</span> <em>Statistics in Medicine</em> 22 (14): 2281–98. <a href="https://doi.org/10.1002/sim.1394">https://doi.org/10.1002/sim.1394</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>